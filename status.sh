#!/bin/bash
# ä¸€é”®æ£€æŸ¥ç³»ç»ŸçŠ¶æ€

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘          RoboCup UR5e ç³»ç»ŸçŠ¶æ€æ£€æŸ¥                          â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# 1. æ£€æŸ¥ Docker é•œåƒ
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“¦ Docker é•œåƒï¼š"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
if docker images | grep robocup_ur5e > /dev/null 2>&1; then
    docker images | grep robocup_ur5e | while read line; do
        echo "  âœ… $line"
    done
else
    echo "  âŒ æœªæ‰¾åˆ° robocup_ur5e é•œåƒ"
    echo "     è¿è¡Œ: ./rebuild_all.sh"
fi
echo ""

# 2. æ£€æŸ¥å®¹å™¨çŠ¶æ€
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ³ å®¹å™¨çŠ¶æ€ï¼š"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
if docker-compose ps 2>/dev/null | grep -q "Up"; then
    docker-compose ps | tail -n +3 | while read line; do
        if echo "$line" | grep -q "Up"; then
            echo "  âœ… $line"
        else
            echo "  âš ï¸  $line"
        fi
    done
else
    echo "  âš ï¸  å®¹å™¨æœªè¿è¡Œ"
    echo "     å¯åŠ¨: ./start.sh æˆ– docker-compose up -d"
fi
echo ""

# 3. æ£€æŸ¥ç½‘ç»œé…ç½®
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸŒ ç½‘ç»œé…ç½®ï¼š"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
if [ -f ".env" ]; then
    echo "  âœ… .env é…ç½®æ–‡ä»¶å­˜åœ¨"
    echo "     $(grep ROS_MASTER_URI .env)"
    echo "     $(grep ROS_IP .env)"
else
    echo "  âŒ .env æ–‡ä»¶ä¸å­˜åœ¨"
fi

echo ""
echo -n "  VM è¿æ¥ (192.168.56.101): "
if ping -c 1 -W 2 192.168.56.101 > /dev/null 2>&1; then
    echo "âœ… å¯è¾¾"
else
    echo "âŒ ä¸å¯è¾¾"
    echo "     è¯·æ£€æŸ¥ VirtualBox VM æ˜¯å¦å¯åŠ¨"
fi
echo ""

# 4. æ£€æŸ¥ ROS è¯é¢˜ï¼ˆå¦‚æœå®¹å™¨åœ¨è¿è¡Œï¼‰
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“¡ ROS è¯é¢˜ï¼š"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
if docker-compose ps 2>/dev/null | grep -q "brain.*Up"; then
    topics=$(docker-compose exec -T brain bash -c "source /workspace/devel/setup.bash && timeout 3 rostopic list 2>/dev/null" 2>/dev/null)
    if [ -n "$topics" ]; then
        echo "$topics" | while read topic; do
            echo "  âœ… $topic"
        done
    else
        echo "  âš ï¸  æ— æ³•è¿æ¥åˆ° ROS Master"
        echo "     è¯·ç¡®ä¿ VM ä¸­è¿è¡Œäº† roscore"
    fi
else
    echo "  âš ï¸  Brain å®¹å™¨æœªè¿è¡Œï¼Œæ— æ³•æ£€æŸ¥è¯é¢˜"
fi
echo ""

# 5. æ£€æŸ¥ GPU
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ® GPU çŠ¶æ€ï¼š"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
if command -v nvidia-smi > /dev/null 2>&1; then
    echo "  âœ… NVIDIA é©±åŠ¨å·²å®‰è£…"
    nvidia-smi --query-gpu=index,name,driver_version,memory.total --format=csv,noheader 2>/dev/null | while read line; do
        echo "     GPU $line"
    done
else
    echo "  âš ï¸  nvidia-smi æœªæ‰¾åˆ°"
fi
echo ""

# æ€»ç»“
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“‹ å¿«é€Ÿå‘½ä»¤ï¼š"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "  å¯åŠ¨ç³»ç»Ÿ:         ./start.sh"
echo "  æŸ¥çœ‹çŠ¶æ€:         docker-compose ps"
echo "  æŸ¥çœ‹æ—¥å¿—:         docker-compose logs -f"
echo "  åœæ­¢ç³»ç»Ÿ:         docker-compose down"
echo "  é‡å»ºé•œåƒ:         ./rebuild_all.sh"
echo "  æŸ¥çœ‹è¯é¢˜:         docker-compose exec brain bash"
echo "                    source /workspace/devel/setup.bash"
echo "                    rostopic list"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
